<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(~{::title}, ~{::section})}">
<head>
    <meta charset="UTF-8">
    <title>添加商品 - 暖心助农选品平台</title>
</head>
<body>
    <section>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1 d-flex align-items-center">
                    <i class="bi bi-plus-circle me-2 text-success"></i>添加商品
                </h2>
                <p class="text-muted mb-0">发布新的农产品，扩展您的销售渠道</p>
            </div>
            <a th:href="@{/product/farmer/list}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left me-2"></i>返回商品列表
            </a>
        </div>
        
        <div class="card">
            <div class="card-body">
                <form id="productForm" class="needs-validation" novalidate>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">商品名称</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                                <div class="invalid-feedback">请输入商品名称</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="price" class="form-label">价格 (元)</label>
                                <div class="input-group">
                                    <span class="input-group-text">￥</span>
                                    <input type="number" class="form-control" id="price" name="price" step="0.01" required>
                                    <div class="invalid-feedback">请输入有效价格</div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="stock" class="form-label">库存数量</label>
                                <input type="number" class="form-control" id="stock" name="stock" required>
                                <div class="invalid-feedback">请输入库存数量</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="category" class="form-label">商品分类</label>
                                <select class="form-select" id="category" name="category" required>
                                    <option value="">请选择分类</option>
                                    <option value="水果">水果</option>
                                    <option value="蔬菜">蔬菜</option>
                                    <option value="粮油">粮油</option>
                                    <option value="其他">其他</option>
                                </select>
                                <div class="invalid-feedback">请选择商品分类</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="description" class="form-label">商品描述</label>
                                <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
                                <div class="invalid-feedback">请输入商品描述</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="image" class="form-label">商品图片</label>
                                <input type="file" class="form-control" id="image" accept="image/*" required>
                                <div class="invalid-feedback">请上传商品图片</div>
                                <input type="hidden" id="imageUrl" name="image">
                                <div class="form-text">建议上传清晰、美观的商品图片，尺寸不小于800×800像素</div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="text-center p-3 border rounded bg-light" id="imagePreviewContainer">
                                    <img id="preview" src="" alt="预览图" class="img-fluid" style="max-height: 200px; display: none;">
                                    <div id="previewPlaceholder" class="text-muted">
                                        <i class="bi bi-image fs-1"></i>
                                        <p>图片预览区域</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end mt-4">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="window.location.href='/product/farmer/list'">
                            <i class="bi bi-x-circle me-1"></i>取消
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>提交商品
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>
    
    <script th:fragment="scripts">
        // 图片预览
        document.getElementById('image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('preview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    document.getElementById('previewPlaceholder').style.display = 'none';
                }
                reader.readAsDataURL(file);
                
                // 上传图片
                const formData = new FormData();
                formData.append('file', file);
                
                // 使用axios替代fetch
                axios.post('/product/farmer/upload', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                })
                .then(response => {
                    document.getElementById('imageUrl').value = response.data;
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('图片上传失败');
                });
            }
        });

        // 表单验证
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('.needs-validation');
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        });

        // 提交表单
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!this.checkValidity()) {
                this.classList.add('was-validated');
                return;
            }
            
            const formData = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                price: parseFloat(document.getElementById('price').value),
                stock: parseInt(document.getElementById('stock').value),
                category: document.getElementById('category').value,
                image: document.getElementById('imageUrl').value
            };

            // 使用axios替代fetch
            axios.post('/product/farmer/add', formData)
                .then(response => {
                    alert(response.data);
                    if (response.data.includes('成功')) {
                        window.location.href = '/product/farmer/list';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('添加失败，请重试');
                });
        });
    </script>
</body>
</html> 