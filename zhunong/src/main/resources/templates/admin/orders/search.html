<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layout/base :: layout(~{::title}, ~{::section})}">
<head>
    <title>订单高级搜索 - 暖心助农选品平台</title>
</head>
<body>
    <section>
        <!-- 页面标题 -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
            <div>
                <h2 class="mb-1 d-flex align-items-center">
                    <i class="bi bi-search me-2 text-primary"></i>订单高级搜索
                </h2>
                <p class="text-muted mb-0">使用多种条件精确查找订单</p>
            </div>
            <div class="mt-3 mt-md-0">
                <a th:href="@{/admin/orders/list}" class="btn btn-outline-primary">
                    <i class="bi bi-receipt me-1"></i>全部订单
                </a>
            </div>
        </div>
        
        <!-- 高级搜索表单 -->
        <div class="card mb-4">
            <div class="card-body">
                <form th:action="@{/admin/orders/search}" method="get" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">订单号</label>
                        <input type="text" class="form-control" name="orderNo" placeholder="搜索订单号" th:value="${orderNo}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">员工姓名</label>
                        <input type="text" class="form-control" name="employeeName" placeholder="员工姓名" th:value="${employeeName}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">订单状态</label>
                        <select class="form-select" name="status">
                            <option value="">全部状态</option>
                            <option value="待付款" th:selected="${status == '待付款'}">待付款</option>
                            <option value="已付款" th:selected="${status == '已付款'}">已付款</option>
                            <option value="待发货" th:selected="${status == '待发货'}">待发货</option>
                            <option value="已发货" th:selected="${status == '已发货'}">已发货</option>
                            <option value="已完成" th:selected="${status == '已完成'}">已完成</option>
                            <option value="已取消" th:selected="${status == '已取消'}">已取消</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">最小金额</label>
                        <input type="number" class="form-control" name="minAmount" placeholder="最小金额" step="0.01" th:value="${minAmount}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">最大金额</label>
                        <input type="number" class="form-control" name="maxAmount" placeholder="最大金额" step="0.01" th:value="${maxAmount}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">支付状态</label>
                        <select class="form-select" name="paymentStatus">
                            <option value="">全部</option>
                            <option value="1" th:selected="${paymentStatus == 1}">已支付</option>
                            <option value="0" th:selected="${paymentStatus == 0}">未支付</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">开始日期</label>
                        <input type="date" class="form-control" name="startDate" th:value="${startDate}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">结束日期</label>
                        <input type="date" class="form-control" name="endDate" th:value="${endDate}">
                    </div>
                    <div class="col-12 d-flex justify-content-end gap-2">
                        <a th:href="@{/admin/orders/search}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle me-1"></i>重置
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search me-1"></i>搜索
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 数据表格 -->
        <div class="card">
            <div class="card-body p-0">
                <!-- 空数据提示 -->
                <div class="empty-state p-5" th:if="${#lists.isEmpty(orders.records)}">
                    <div class="d-flex flex-column align-items-center">
                        <i class="bi bi-receipt empty-state-icon text-muted"></i>
                        <h5 class="mt-3">暂无订单</h5>
                        <p class="text-muted">当前没有符合条件的订单</p>
                    </div>
                </div>
                
                <div class="table-responsive" th:if="${not #lists.isEmpty(orders.records)}">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>订单号</th>
                                <th>员工</th>
                                <th>商品数量</th>
                                <th>总金额</th>
                                <th>状态</th>
                                <th>支付方式</th>
                                <th>创建时间</th>
                                <th style="width: 150px;">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="order : ${orders.records}">
                                <td>
                                    <div class="fw-medium" th:text="${order.orderNo}">订单号</div>
                                </td>
                                <td th:text="${order.employeeName}">员工</td>
                                <td th:if="${order.items != null}" th:text="${order.items.size() + '件'}">商品数量</td>
                                <td th:unless="${order.items != null}">未知</td>
                                <td>
                                    <span class="text-primary fw-bold" th:text="'￥' + ${order.totalAmount}">总金额</span>
                                </td>
                                <td>
                                    <span class="badge bg-warning" th:if="${order.status == '待付款'}">待付款</span>
                                    <span class="badge bg-info" th:if="${order.status == '已付款'}">已付款</span>
                                    <span class="badge bg-secondary" th:if="${order.status == '待发货'}">待发货</span>
                                    <span class="badge bg-primary" th:if="${order.status == '已发货'}">已发货</span>
                                    <span class="badge bg-success" th:if="${order.status == '已完成'}">已完成</span>
                                    <span class="badge bg-danger" th:if="${order.status == '已取消'}">已取消</span>
                                </td>
                                <td>
                                    <span th:if="${order.status == '已付款' || order.status == '待发货' || order.status == '已发货' || order.status == '已完成'}">已支付</span>
                                    <span th:if="${order.status == '待付款'}">未支付</span>
                                    <span th:if="${order.status == '已取消'}">已取消</span>
                                </td>
                                <td>
                                    <span th:text="${#temporals.format(order.createTime, 'yyyy-MM-dd')}" class="d-block">日期</span>
                                    <small class="text-muted" th:text="${#temporals.format(order.createTime, 'HH:mm')}">时间</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{'/admin/orders/detail/' + ${order.id}}" class="btn btn-outline-primary">
                                            <i class="bi bi-eye me-1"></i>详情
                                        </a>
                                        <button class="btn btn-outline-danger" 
                                                th:if="${order.status == '待付款' || order.status == '已付款'}"
                                                th:onclick="'cancelOrder(' + ${order.id} + ')'">
                                            <i class="bi bi-x-circle me-1"></i>取消
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 分页 -->
            <div class="card-footer bg-white" th:if="${not #lists.isEmpty(orders.records)}">
                <div th:replace="~{layout/pagination :: pagination('/admin/orders/search', ${orders}, 10, '')}"></div>
            </div>
        </div>
    </section>
    
    <script th:fragment="scripts">
        // 初始化工具提示
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
        
        // 取消订单
        function cancelOrder(orderId) {
            if (confirm('确定要取消此订单吗？此操作不可撤销！')) {
                fetch('/admin/orders/cancel/' + orderId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.text())
                .then(result => {
                    alert(result);
                    if (result.indexOf('成功') !== -1) {
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('操作失败，请重试');
                });
            }
        }
        
        // 显示提示消息
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container') || (() => {
                const container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'position-fixed bottom-0 end-0 p-3';
                container.style.zIndex = '1050';
                document.body.appendChild(container);
                return container;
            })();
            
            const toastId = 'toast-' + Date.now();
            const toastEl = document.createElement('div');
            toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
            toastEl.id = toastId;
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
            
            toastEl.addEventListener('hidden.bs.toast', () => {
                toastEl.remove();
            });
        }
    </script>
    
    <style th:fragment="styles">
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            text-align: center;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }
        
        .badge {
            font-weight: 500;
            padding: 0.35em 0.65em;
        }
        
        .form-label {
            font-weight: 500;
        }
    </style>
</body>
</html> 