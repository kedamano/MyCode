<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layout/base :: layout(~{::title}, ~{::section})}">
<head>
    <meta charset="UTF-8">
    <title>统计报表 - 暖心助农选品平台</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.2/echarts.min.js"></script>
</head>
<body>
    <section>
        <!-- 页面标题 -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
            <div>
                <h2 class="mb-1 d-flex align-items-center">
                    <i class="bi bi-graph-up-arrow me-2 text-primary"></i>统计报表
            </h2>
                <p class="text-muted mb-0">查看平台业务数据和销售情况分析</p>
            </div>
            <div class="d-flex gap-2 mt-3 mt-md-0">
                <button id="printReport" class="btn btn-outline-primary d-flex align-items-center">
                    <i class="bi bi-printer me-2"></i>打印报表
                </button>
                <div class="dropdown">
                    <button type="button" class="btn btn-primary dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown">
                        <i class="bi bi-calendar-range me-2"></i>时间范围
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item time-range d-flex align-items-center" href="#" data-range="7"><i class="bi bi-calendar-week me-2"></i>最近7天</a></li>
                        <li><a class="dropdown-item time-range d-flex align-items-center" href="#" data-range="30"><i class="bi bi-calendar-month me-2"></i>最近30天</a></li>
                        <li><a class="dropdown-item time-range d-flex align-items-center" href="#" data-range="90"><i class="bi bi-calendar3 me-2"></i>最近90天</a></li>
                        <li><a class="dropdown-item time-range d-flex align-items-center" href="#" data-range="365"><i class="bi bi-calendar-fill me-2"></i>最近一年</a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- 统计卡片 -->
        <div th:replace="~{layout/stats :: income-stats('￥' + ${todaySales}, '￥' + ${monthSales}, '￥' + ${totalSales}, '￥' + ${avgOrderValue})}"></div>
        
        <!-- 订单统计卡片 -->
        <div th:replace="~{layout/stats :: order-stats(${todayOrders}, ${totalOrders}, ${pendingOrders}, ${completedOrders})}"></div>
        
        <!-- 图表区域 -->
        <div class="row mb-4">
            <!-- 销售趋势图 -->
            <div class="col-12">
                <div th:replace="~{layout/stats :: dashboard-stats('销售趋势分析', '查看不同时间维度的销售数据变化')}"></div>
                <div th:replace="~{layout/chart :: line-chart('salesChart', '销售趋势', 'graph-up', ${salesDates}, ${salesData}, '#2ecc71')}"></div>
                        </div>
                    </div>
        
        <div class="row g-4 mb-4">
            <!-- 分类销售占比 -->
            <div class="col-md-6 col-lg-4">
                <div th:replace="~{layout/chart :: pie-chart('categoryChart', '分类销售占比', 'pie-chart', ${categoryData}, null)}"></div>
            </div>
            
            <!-- 订单状态分布 -->
            <div class="col-md-6 col-lg-4">
                <div th:replace="~{layout/chart :: pie-chart('orderStatusChart', '订单状态分布', 'clipboard-check', ${orderStatusData}, null)}"></div>
            </div>
            
            <!-- 每月订单数量 -->
            <div class="col-md-12 col-lg-4">
                <div th:replace="~{layout/chart :: bar-chart('monthlyOrdersChart', '月度订单数量', 'bar-chart', ${#arrays.toArray({'1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'})}, ${monthlyOrdersData}, '#3498db')}"></div>
            </div>
        </div>
        
        <div class="row g-4 mb-4">
            <!-- 职工购买排行 -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                            <i class="bi bi-person-badge me-2"></i>职工购买排行
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="查看详细数据">
                            <i class="bi bi-info-circle"></i>
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>职工</th>
                                        <th>部门</th>
                                        <th>订单数</th>
                                        <th>消费金额</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="employee, stat : ${topEmployees}">
                                        <td><span th:text="${stat.count}" class="badge bg-primary">1</span></td>
                                        <td th:text="${employee.name}">张三</td>
                                        <td th:text="${employee.department}">财务部</td>
                                        <td th:text="${employee.orderCount}">12</td>
                                        <td th:text="'¥' + ${employee.totalAmount}">¥1256.00</td>
                                    </tr>
                                    <!-- 若无数据则显示示例数据 -->
                                    <tr th:if="${#lists.isEmpty(topEmployees) || topEmployees == null}">
                                        <td><span class="badge bg-primary">1</span></td>
                                        <td>张三</td>
                                        <td>财务部</td>
                                        <td>12</td>
                                        <td>¥1256.00</td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(topEmployees) || topEmployees == null}">
                                        <td><span class="badge bg-primary">2</span></td>
                                        <td>李四</td>
                                        <td>人事部</td>
                                        <td>10</td>
                                        <td>¥986.50</td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(topEmployees) || topEmployees == null}">
                                        <td><span class="badge bg-primary">3</span></td>
                                        <td>王五</td>
                                        <td>技术部</td>
                                        <td>8</td>
                                        <td>¥876.00</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 农户销售排行 -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                            <i class="bi bi-people me-2"></i>农户销售排行
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="查看详细数据">
                            <i class="bi bi-info-circle"></i>
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>农户</th>
                                        <th>地区</th>
                                        <th>销售订单</th>
                                        <th>销售金额</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="farmer, stat : ${topFarmers}">
                                        <td><span th:text="${stat.count}" class="badge bg-success">1</span></td>
                                        <td th:text="${farmer.name}">李大牛</td>
                                        <td th:text="${farmer.region}">河北省</td>
                                        <td th:text="${farmer.orderCount}">15</td>
                                        <td th:text="'¥' + ${farmer.totalAmount}">¥1856.00</td>
                                    </tr>
                                    <!-- 若无数据则显示示例数据 -->
                                    <tr th:if="${#lists.isEmpty(topFarmers) || topFarmers == null}">
                                        <td><span class="badge bg-success">1</span></td>
                                        <td>李大牛</td>
                                        <td>河北省</td>
                                        <td>15</td>
                                        <td>¥1856.00</td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(topFarmers) || topFarmers == null}">
                                        <td><span class="badge bg-success">2</span></td>
                                        <td>王小花</td>
                                        <td>山东省</td>
                                        <td>13</td>
                                        <td>¥1635.50</td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(topFarmers) || topFarmers == null}">
                                        <td><span class="badge bg-success">3</span></td>
                                        <td>赵四海</td>
                                        <td>河南省</td>
                                        <td>11</td>
                                        <td>¥1425.00</td>
                                    </tr>
                                </tbody>
                            </table>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 商品销售排行 -->
        <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0 d-flex align-items-center">
                    <i class="bi bi-box-seam me-2"></i>商品销售排行
                </h5>
                <div class="d-flex gap-2">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-funnel me-1"></i>分类筛选
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#">全部分类</a></li>
                            <li><a class="dropdown-item" href="#">水果</a></li>
                            <li><a class="dropdown-item" href="#">蔬菜</a></li>
                            <li><a class="dropdown-item" href="#">粮油</a></li>
                            <li><a class="dropdown-item" href="#">干货</a></li>
                            </ul>
                    </div>
                    <button class="btn btn-sm btn-primary">
                        <i class="bi bi-download me-1"></i>导出数据
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                <th>排名</th>
                                <th>商品</th>
                                <th>分类</th>
                                <th>农户</th>
                                <th>销量</th>
                                <th>单价</th>
                                <th>销售额</th>
                                                <th>趋势</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            <tr th:each="product, stat : ${topProducts}">
                                <td><span th:text="${stat.count}" class="badge bg-primary">1</span></td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img th:if="${product.image}" th:src="@{${product.image}}" class="me-2" width="36" height="36" alt="商品图片">
                                        <img th:unless="${product.image}" src="/images/product-placeholder.jpg" class="me-2" width="36" height="36" alt="商品图片">
                                        <span th:text="${product.name}">有机红富士苹果</span>
                                    </div>
                                </td>
                                <td><span th:text="${product.category}" class="badge bg-light text-dark">水果</span></td>
                                <td th:text="${product.farmerName}">李大牛</td>
                                <td th:text="${product.salesCount}">158</td>
                                <td th:text="'¥' + ${product.price}">¥12.80</td>
                                <td th:text="'¥' + ${product.totalSales}">¥2022.40</td>
                                <td>
                                    <span th:if="${product.trend > 0}" class="text-success"><i class="bi bi-arrow-up-right"></i></span>
                                    <span th:if="${product.trend < 0}" class="text-danger"><i class="bi bi-arrow-down-right"></i></span>
                                    <span th:if="${product.trend == 0}" class="text-muted"><i class="bi bi-dash"></i></span>
                                </td>
                            </tr>
                            <!-- 若无数据则显示示例数据 -->
                            <tr th:if="${#lists.isEmpty(topProducts) || topProducts == null}">
                                <td><span class="badge bg-primary">1</span></td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="/images/product-placeholder.jpg" class="me-2" width="36" height="36" alt="商品图片">
                                        <span>有机红富士苹果</span>
                                                    </div>
                                                </td>
                                <td><span class="badge bg-light text-dark">水果</span></td>
                                <td>李大牛</td>
                                <td>158</td>
                                <td>¥12.80</td>
                                <td>¥2022.40</td>
                                <td><span class="text-success"><i class="bi bi-arrow-up-right"></i></span></td>
                                            </tr>
                            <tr th:if="${#lists.isEmpty(topProducts) || topProducts == null}">
                                <td><span class="badge bg-primary">2</span></td>
                                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="/images/product-placeholder.jpg" class="me-2" width="36" height="36" alt="商品图片">
                                        <span>新鲜西红柿</span>
                                                    </div>
                                                </td>
                                <td><span class="badge bg-light text-dark">蔬菜</span></td>
                                <td>王小花</td>
                                <td>142</td>
                                <td>¥5.80</td>
                                <td>¥823.60</td>
                                <td><span class="text-success"><i class="bi bi-arrow-up-right"></i></span></td>
                                            </tr>
                            <tr th:if="${#lists.isEmpty(topProducts) || topProducts == null}">
                                <td><span class="badge bg-primary">3</span></td>
                                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="/images/product-placeholder.jpg" class="me-2" width="36" height="36" alt="商品图片">
                                        <span>农家小米</span>
                                                    </div>
                                                </td>
                                <td><span class="badge bg-light text-dark">粮油</span></td>
                                <td>赵四海</td>
                                <td>126</td>
                                <td>¥9.90</td>
                                <td>¥1247.40</td>
                                <td><span class="text-danger"><i class="bi bi-arrow-down-right"></i></span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
            <div class="card-footer">
                <nav>
                    <ul class="pagination justify-content-center mb-0">
                        <li class="page-item disabled">
                            <a class="page-link" href="#"><i class="bi bi-chevron-left"></i></a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#"><i class="bi bi-chevron-right"></i></a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </section>
    
    <script th:fragment="scripts">
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化所有提示工具
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // 切换时间范围
            document.querySelectorAll('.time-range').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const range = this.getAttribute('data-range');
                    
                    // 使用axios请求替代简单的alert
                    axios.get('/admin/statistics/data', {
                        params: { range: range }
                    })
                    .then(function(response) {
                        // 更新各个图表和数据
                        if (response.data) {
                            // 这里可以根据返回的数据更新页面上的各个图表和统计数字
                            showToast('数据已更新为最近 ' + range + ' 天', 'success');
                            
                            // 如果后端返回了完整的数据，可以刷新页面
                            // location.reload();
                        }
                    })
                    .catch(function(error) {
                        console.error('获取数据失败:', error);
                        showToast('获取数据失败，请重试', 'danger');
                    });
                });
            });
            
            // 打印报表
            document.getElementById('printReport').addEventListener('click', function() {
                window.print();
            });
        });
    </script>
    
    <style th:fragment="styles">
        @media print {
            .navbar, .footer, .btn, button {
                display: none !important;
            }
            
            .card {
                border: 1px solid #ddd !important;
                box-shadow: none !important;
            }
            
            body {
                background-color: white !important;
            }
        }
        
        .badge {
            padding: 0.35em 0.65em;
        }
    </style>
</body>
</html>