<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layout/base :: layout(~{::title}, ~{::section})}">
<head>
    <title>待审核农户 - 暖心助农选品平台</title>
</head>
<body>
    <section>
        <!-- 页面标题 -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
            <div>
                <h2 class="mb-1 d-flex align-items-center">
                    <i class="bi bi-person-exclamation me-2 text-primary"></i>待审核农户
                </h2>
                <p class="text-muted mb-0">审核新注册的农户账户申请</p>
            </div>
            <div class="mt-3 mt-md-0">
                <a th:href="@{/admin/farmers/add}" class="btn btn-primary">
                    <i class="bi bi-person-plus me-1"></i>添加农户
                </a>
            </div>
        </div>
        
        <!-- 导航标签 -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link active d-flex align-items-center" th:href="@{/admin/farmers/pending}">
                    <i class="bi bi-hourglass-split me-1"></i>待审核
                    <span class="badge bg-primary rounded-pill ms-1" th:if="${farmers.total > 0}" th:text="${farmers.total}">12</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link d-flex align-items-center" th:href="@{/admin/farmers/approved}">
                    <i class="bi bi-check-circle me-1"></i>已审核
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link d-flex align-items-center" th:href="@{/admin/farmers/disabled}">
                    <i class="bi bi-slash-circle me-1"></i>已禁用
                </a>
            </li>
        </ul>
        
        <!-- 空数据提示 -->
        <div class="empty-state" th:if="${#lists.isEmpty(farmers.records)}">
            <i class="bi bi-hourglass empty-state-icon"></i>
            <h5 class="empty-state-text">暂无待审核农户</h5>
            <p class="empty-state-subtext">目前没有待审核的农户账户申请</p>
            <a th:href="@{/admin/farmers/approved}" class="btn btn-primary">
                <i class="bi bi-check-circle me-1"></i>查看已审核农户
            </a>
        </div>
        
        <!-- 数据表格 -->
        <div class="card" th:if="${not #lists.isEmpty(farmers.records)}">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>用户名</th>
                                <th>真实姓名</th>
                                <th>联系电话</th>
                                <th>邮箱</th>
                                <th>地区</th>
                                <th>注册时间</th>
                                <th style="width: 150px;">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="farmer : ${farmers.records}">
                                <td th:text="${farmer.username}">用户名</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-placeholder me-2">
                                            <span th:text="${#strings.substring(farmer.realName, 0, 1)}">张</span>
                                        </div>
                                        <span th:text="${farmer.realName}">真实姓名</span>
                                    </div>
                                </td>
                                <td th:text="${farmer.phone}">联系电话</td>
                                <td th:text="${farmer.email}">邮箱</td>
                                <td th:text="${farmer.address}">地区</td>
                                <td>
                                    <span th:text="${#temporals.format(farmer.createTime, 'yyyy-MM-dd')}" class="d-block">日期</span>
                                    <small class="text-muted" th:text="${#temporals.format(farmer.createTime, 'HH:mm')}">时间</small>
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <a th:href="@{'/admin/farmers/detail/' + ${farmer.id}}" class="btn btn-outline-primary">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <button class="btn btn-outline-success" th:onclick="'reviewFarmer(' + ${farmer.id} + ', true)'">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" th:onclick="'reviewFarmer(' + ${farmer.id} + ', false)'">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white">
                <div th:replace="~{layout/pagination :: pagination('/admin/farmers/pending', ${farmers}, 10, '')}"></div>
            </div>
        </div>
    </section>

    <script th:fragment="scripts">
        function reviewFarmer(farmerId, approved) {
            if (confirm(`确定要${approved ? '通过' : '拒绝'}该农户的注册申请吗？`)) {
                // 禁用相关按钮，防止重复提交
                const buttons = document.querySelectorAll(`button[onclick*="${farmerId}"]`);
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                });
                
                const Toast = {
                    show(message, type = 'success') {
                        const toastContainer = document.getElementById('toast-container') || (() => {
                            const container = document.createElement('div');
                            container.id = 'toast-container';
                            container.className = 'position-fixed bottom-0 end-0 p-3';
                            container.style.zIndex = '1050';
                            document.body.appendChild(container);
                            return container;
                        })();
                        
                        const toastId = 'toast-' + Date.now();
                        const toastEl = document.createElement('div');
                        toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
                        toastEl.id = toastId;
                        toastEl.setAttribute('role', 'alert');
                        toastEl.setAttribute('aria-live', 'assertive');
                        toastEl.setAttribute('aria-atomic', 'true');
                        
                        toastEl.innerHTML = `
                            <div class="d-flex">
                                <div class="toast-body">
                                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                                    ${message}
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        `;
                        
                        toastContainer.appendChild(toastEl);
                        const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                        toast.show();
                        
                        toastEl.addEventListener('hidden.bs.toast', () => {
                            toastEl.remove();
                        });
                    }
                };
                
                // 使用axios替代fetch
                axios.post(`/admin/farmers/review/${farmerId}`, 
                    `approved=${approved}`,
                    {
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    }
                )
                .then(response => {
                    const result = response.data;
                    Toast.show(result, result.includes('成功') ? 'success' : 'danger');
                    if (result.includes('成功')) {
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        // 恢复按钮状态
                        buttons.forEach(btn => {
                            btn.disabled = false;
                            btn.innerHTML = btn.classList.contains('btn-outline-success') ? 
                                '<i class="bi bi-check-lg"></i>' : 
                                '<i class="bi bi-x-lg"></i>';
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Toast.show('操作失败，请重试', 'danger');
                    
                    // 恢复按钮状态
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.innerHTML = btn.classList.contains('btn-outline-success') ? 
                            '<i class="bi bi-check-lg"></i>' : 
                            '<i class="bi bi-x-lg"></i>';
                    });
                });
            }
        }
    </script>
    
    <style th:fragment="styles">
        .avatar-placeholder {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-light);
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .nav-tabs .nav-link {
            color: var(--text-color);
            padding: 0.75rem 1rem;
            border: none;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
        }
        
        .nav-tabs .nav-link:hover:not(.active) {
            border-color: var(--primary-light);
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-color: var(--primary-color);
            background-color: transparent;
            font-weight: 600;
        }
        
        .table td {
            vertical-align: middle;
        }
    </style>
</body>
</html> 