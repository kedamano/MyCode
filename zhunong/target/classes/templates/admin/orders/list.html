<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layout/base :: layout(~{::title}, ~{::section})}">
<head>
    <title>订单管理 - 暖心助农选品平台</title>
</head>
<body>
    <section>
        <!-- 页面标题 -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
            <div>
                <h2 class="mb-1 d-flex align-items-center">
                    <i class="bi bi-receipt me-2 text-primary"></i>订单管理
                </h2>
                <p class="text-muted mb-0">管理平台上的所有订单</p>
            </div>
            <div class="mt-3 mt-md-0 d-flex gap-2">
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-download me-1"></i>导出数据
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                        <li><a class="dropdown-item" th:href="@{/admin/orders/export/excel}">导出为Excel</a></li>
                        <li><a class="dropdown-item" th:href="@{/admin/orders/export/csv}">导出为CSV</a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- 搜索栏 -->
        <div class="card mb-4">
            <div class="card-body">
                <form th:action="@{/admin/orders/list}" method="get" class="row g-2">
                    <div class="col-md-4">
                        <div class="input-group">
                            <input type="text" class="form-control" name="keyword" placeholder="搜索订单号或员工姓名" th:value="${keyword}">
                            <button class="btn btn-primary" type="submit">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" name="status">
                            <option value="">全部状态</option>
                            <option value="待付款" th:selected="${status == '待付款'}">待付款</option>
                            <option value="已付款" th:selected="${status == '已付款'}">已付款</option>
                            <option value="待发货" th:selected="${status == '待发货'}">待发货</option>
                            <option value="已发货" th:selected="${status == '已发货'}">已发货</option>
                            <option value="已完成" th:selected="${status == '已完成'}">已完成</option>
                            <option value="已取消" th:selected="${status == '已取消'}">已取消</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" name="timeRange">
                            <option value="">全部时间</option>
                            <option value="today" th:selected="${timeRange == 'today'}">今天</option>
                            <option value="yesterday" th:selected="${timeRange == 'yesterday'}">昨天</option>
                            <option value="thisWeek" th:selected="${timeRange == 'thisWeek'}">本周</option>
                            <option value="lastWeek" th:selected="${timeRange == 'lastWeek'}">上周</option>
                            <option value="thisMonth" th:selected="${timeRange == 'thisMonth'}">本月</option>
                            <option value="lastMonth" th:selected="${timeRange == 'lastMonth'}">上月</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <a th:href="@{/admin/orders/list}" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-x-circle me-1"></i>重置
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 数据表格 -->
        <div class="card">
            <div class="card-body p-0">
                <!-- 空数据提示 -->
                <div class="empty-state p-5" th:if="${#lists.isEmpty(orders.records)}">
                    <div class="d-flex flex-column align-items-center">
                        <i class="bi bi-receipt empty-state-icon text-muted"></i>
                        <h5 class="mt-3">暂无订单</h5>
                        <p class="text-muted">当前没有符合条件的订单</p>
                    </div>
                </div>
                
                <div class="table-responsive" th:if="${not #lists.isEmpty(orders.records)}">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>订单号</th>
                                <th>员工</th>
                                <th>商品数量</th>
                                <th>总金额</th>
                                <th>状态</th>
                                <th>支付方式</th>
                                <th>创建时间</th>
                                <th style="width: 220px;">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="order : ${orders.records}">
                                <td>
                                    <div class="fw-medium" th:text="${order.orderNo}">订单号</div>
                                </td>
                                <td th:text="${order.employeeName}">员工</td>
                                <td th:if="${order.items != null}" th:text="${order.items.size() + '件'}">商品数量</td>
                                <td th:unless="${order.items != null}">未知</td>
                                <td>
                                    <span class="text-primary fw-bold" th:text="'￥' + ${order.totalAmount}">总金额</span>
                                </td>
                                <td>
                                    <span class="badge bg-warning" th:if="${order.status == '待付款'}">待付款</span>
                                    <span class="badge bg-info" th:if="${order.status == '已付款'}">已付款</span>
                                    <span class="badge bg-secondary" th:if="${order.status == '待发货'}">待发货</span>
                                    <span class="badge bg-primary" th:if="${order.status == '已发货'}">已发货</span>
                                    <span class="badge bg-success" th:if="${order.status == '已收货'}">已收货</span>
                                    <span class="badge bg-danger" th:if="${order.status == '已取消'}">已取消</span>
                                </td>
                                <td>
                                    <span th:if="${order.status == '已付款' || order.status == '待发货' || order.status == '已发货' || order.status == '已收货'}">已支付</span>
                                    <span th:if="${order.status == '待付款'}">未支付</span>
                                    <span th:if="${order.status == '已取消'}">已取消</span>
                                </td>
                                <td>
                                    <span th:text="${#temporals.format(order.createTime, 'yyyy-MM-dd')}" class="d-block">日期</span>
                                    <small class="text-muted" th:text="${#temporals.format(order.createTime, 'HH:mm')}">时间</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{'/admin/orders/detail/' + ${order.id}}" class="btn btn-outline-primary">
                                            <i class="bi bi-eye me-1"></i>详情
                                        </a>
                                        <a th:href="@{'/admin/orders/edit/' + ${order.id}}" class="btn btn-outline-secondary">
                                            <i class="bi bi-pencil me-1"></i>编辑
                                        </a>
                                        <button class="btn btn-outline-danger" 
                                                th:if="${order.status == '待付款' || order.status == '已付款'}"
                                                th:onclick="'cancelOrder(' + ${order.id} + ')'">
                                            <i class="bi bi-x-circle me-1"></i>取消
                                        </button>
                                        <button class="btn btn-outline-danger" 
                                                th:onclick="'deleteOrder(' + ${order.id} + ')'">
                                            <i class="bi bi-trash me-1"></i>删除
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 分页 -->
            <div class="card-footer bg-white" th:if="${not #lists.isEmpty(orders.records)}">
                <div th:replace="~{layout/pagination :: pagination('/admin/orders/list', ${orders}, 10, '')}"></div>
            </div>
        </div>
    </section>
    
    <script th:fragment="scripts">
        // 初始化工具提示
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
        
        // 取消订单
        function cancelOrder(orderId) {
            if (confirm('确定要取消此订单吗？此操作不可撤销！')) {
                fetch('/admin/orders/cancel/' + orderId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.text())
                .then(result => {
                    alert(result);
                    if (result.indexOf('成功') !== -1) {
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('操作失败，请重试');
                });
            }
        }
        
        // 删除订单
        function deleteOrder(orderId) {
            if (confirm('确定要删除此订单吗？此操作不可恢复！')) {
                fetch('/admin/orders/delete/' + orderId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.text())
                .then(result => {
                    alert(result);
                    if (result.indexOf('成功') !== -1) {
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('操作失败，请重试');
                });
            }
        }
        
        // 显示提示消息
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container') || (() => {
                const container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'position-fixed bottom-0 end-0 p-3';
                container.style.zIndex = '1050';
                document.body.appendChild(container);
                return container;
            })();
            
            const toastId = 'toast-' + Date.now();
            const toastEl = document.createElement('div');
            toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
            toastEl.id = toastId;
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
            
            toastEl.addEventListener('hidden.bs.toast', function () {
                toastEl.remove();
            });
        }
    </script>
    
    <style th:fragment="styles">
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            text-align: center;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }
        
        .badge {
            font-weight: 500;
            padding: 0.35em 0.65em;
        }
    </style>
</body>
</html> 