<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layout/base :: layout(~{::title}, ~{::section})}">
<head>
    <title>商品管理 - 暖心助农选品平台</title>
</head>
<body>
    <section>
        <!-- 页面标题 -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
            <div>
                <h2 class="mb-1 d-flex align-items-center">
                    <i class="bi bi-box me-2 text-primary"></i>商品管理
                </h2>
                <p class="text-muted mb-0">管理平台上的所有商品</p>
            </div>
            <div class="mt-3 mt-md-0 d-flex gap-2">

                <a th:href="@{/admin/products/pending}" class="btn btn-outline-primary">
                    <i class="bi bi-hourglass-split me-1"></i>待审核商品
                </a>
                <a th:href="@{/product/add}" class="btn btn-primary">
                    <i class="bi bi-plus-lg me-1"></i>添加商品
                </a>
            </div>
        </div>
        
        <!-- 搜索栏 -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="searchForm" th:action="@{/admin/products/list}" method="get" class="row g-2">
                    <div class="col-md-4">
                        <div class="input-group">
                            <input type="text" class="form-control" id="name" name="name" placeholder="搜索商品名称" th:value="${name}">
                            <button class="btn btn-primary" type="submit" id="searchBtn">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="category" name="category">
                            <option value="">全部分类</option>
                            <option value="蔬菜" th:selected="${category == '蔬菜'}">蔬菜</option>
                            <option value="水果" th:selected="${category == '水果'}">水果</option>
                            <option value="粮油" th:selected="${category == '粮油'}">粮油</option>
                            <option value="肉禽蛋" th:selected="${category == '肉禽蛋'}">肉禽蛋</option>
                            <option value="特产" th:selected="${category == '特产'}">特产</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="status" name="status">
                            <option value="">全部状态</option>
                            <option value="1" th:selected="${status == 1}">已上架</option>
                            <option value="2" th:selected="${status == 2}">已下架</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <a th:href="@{/admin/products/search}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-funnel"></i> 高级筛选
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 数据表格 -->
        <div class="card">
            <div class="card-body p-0">
                <!-- 空数据提示 -->
                <div class="empty-state p-5" th:if="${#lists.isEmpty(products.records)}">
                    <div class="d-flex flex-column align-items-center">
                        <i class="bi bi-basket empty-state-icon text-muted"></i>
                        <h5 class="mt-3">暂无商品</h5>
                        <p class="text-muted">当前没有任何商品，点击"添加商品"按钮创建</p>
                        <a th:href="@{/product/add}" class="btn btn-primary mt-3">
                            <i class="bi bi-plus-lg me-1"></i>添加商品
                        </a>
                    </div>
                </div>
                
                <div class="table-responsive" th:if="${not #lists.isEmpty(products.records)}">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 80px;">图片</th>
                                <th>名称</th>
                                <th>分类</th>
                                <th>价格</th>
                                <th>库存</th>
                                <th>销量</th>
                                <th>农户</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th style="width: 240px;">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="product : ${products.records}">
                                <td>
                                    <img th:src="@{${product.image}}" src="/images/product-placeholder.jpg" alt="商品图片" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;">
                                </td>
                                <td>
                                    <div class="fw-medium" th:text="${product.name}">商品名称</div>
                                    <small class="text-muted" th:text="${product.description}">商品描述</small>
                                </td>
                                <td th:text="${product.category}">分类</td>
                                <td>
                                    <span class="text-primary fw-bold" th:text="'￥' + ${product.price}">价格</span>
                                </td>
                                <td th:text="${product.stock}">库存</td>
                                <td th:text="${product.salesCount}">销量</td>
                                <td th:text="${product.farmerName}">农户</td>
                                <td>
                                    <span class="badge bg-success" th:if="${product.status == 1}">已上架</span>
                                    <span class="badge bg-danger" th:if="${product.status == 2}">已下架</span>
                                    <span class="badge bg-warning" th:if="${product.status == 0}">待审核</span>
                                </td>
                                <td>
                                    <span th:text="${#temporals.format(product.createTime, 'yyyy-MM-dd')}" class="d-block">日期</span>
                                    <small class="text-muted" th:text="${#temporals.format(product.createTime, 'HH:mm')}">时间</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{'/admin/products/detail/' + ${product.id}}" class="btn btn-outline-primary">
                                            <i class="bi bi-eye me-1"></i>查看
                                        </a>
                                        <a th:href="@{'/admin/products/edit/' + ${product.id}}" class="btn btn-outline-secondary">
                                            <i class="bi bi-pencil me-1"></i>编辑
                                        </a>
                                        <button th:if="${product.status == 1}" class="btn btn-outline-warning update-status-btn" 
                                                th:data-id="${product.id}" th:data-status="${product.status}">
                                            <i class="bi bi-arrow-down-circle me-1"></i>下架
                                        </button>
                                        <button th:if="${product.status == 2}" class="btn btn-outline-success update-status-btn" 
                                                th:data-id="${product.id}" th:data-status="${product.status}">
                                            <i class="bi bi-arrow-up-circle me-1"></i>上架
                                        </button>
                                        <button class="btn btn-outline-danger delete-product-btn" 
                                                th:data-id="${product.id}" th:data-name="${product.name}">
                                            <i class="bi bi-trash me-1"></i>删除
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 分页 -->
            <div class="card-footer bg-white" th:if="${not #lists.isEmpty(products.records)}">
                <div th:replace="~{layout/pagination :: pagination('/admin/products/list', ${products}, 10, 
                    (${name != null} ? '&name=' + ${name} : '') + 
                    (${category != null} ? '&category=' + ${category} : '') + 
                    (${status != null} ? '&status=' + ${status} : '')
                )}"></div>
            </div>
        </div>
    </section>
    
    <script th:fragment="scripts">
        document.addEventListener('DOMContentLoaded', function() {
            // 搜索表单异步提交
            const searchForm = document.getElementById('searchForm');
            const searchBtn = document.getElementById('searchBtn');
            
            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // 收集搜索参数
                    const params = new URLSearchParams();
                    params.append('name', document.getElementById('name').value || '');
                    params.append('category', document.getElementById('category').value || '');
                    params.append('status', document.getElementById('status').value || '');
                    
                    // 构建URL
                    const url = `/admin/products/list?${params.toString()}`;
                    
                    // 使用window.location进行页面跳转（GET请求）
                    window.location.href = url;
                });
                
                // 分类和状态下拉框变化时自动提交表单
                document.getElementById('category').addEventListener('change', function() {
                    searchBtn.click();
                });
                
                document.getElementById('status').addEventListener('change', function() {
                    searchBtn.click();
                });
            }
            
            // 处理商品操作
            document.querySelectorAll('.btn-status-toggle').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    const action = this.getAttribute('data-action');
                    
                    if (confirm(`确定要${action === 'up' ? '上架' : '下架'}该商品吗？`)) {
                        const url = `/admin/products/${action === 'up' ? 'shelf-on' : 'shelf-off'}/${productId}`;
                        
                        http.post(url)
                            .then(response => {
                                showToast(`商品已${action === 'up' ? '上架' : '下架'}`, 'success');
                                setTimeout(() => {
                                    location.reload();
                                }, 1000);
                            })
                            .catch(error => {
                                showToast('操作失败，请重试', 'danger');
                            });
                    }
                });
            });
            
            document.querySelectorAll('.btn-delete').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    
                    if (confirm('确定要删除该商品吗？此操作不可恢复！')) {
                        http.delete(`/admin/products/delete/${productId}`)
                            .then(response => {
                                showToast('商品已删除', 'success');
                                setTimeout(() => {
                                    location.reload();
                                }, 1000);
                            })
                            .catch(error => {
                                showToast('删除失败，请重试', 'danger');
                            });
                    }
                });
            });
        });
    </script>
    
    <style th:fragment="styles">
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            text-align: center;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }
        
        .badge {
            font-weight: 500;
            padding: 0.35em 0.65em;
        }
    </style>
</body>
</html>