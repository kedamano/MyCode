<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layout/base :: layout(~{::title}, ~{::section})}">
<head>
    <meta charset="UTF-8">
    <title>统计报表 - 暖心助农选品平台</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.2/echarts.min.js"></script>
</head>
<body>
    <section>
        <!-- 页面标题 -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
            <div>
                <h2 class="mb-1 d-flex align-items-center">
                    <i class="bi bi-graph-up-arrow me-2 text-success"></i>平台统计数据
                </h2>
                <p class="text-muted mb-0">查看平台业务数据和销售情况分析</p>
            </div>
            
            <div class="d-flex mt-3 mt-md-0">
                <div class="btn-group">
                    <a th:href="@{/admin/statistics}" class="btn btn-success active">概览</a>
                    <a th:href="@{/admin/statistics/farmers}" class="btn btn-outline-success">农户分析</a>
                    <a th:href="@{/admin/statistics/products}" class="btn btn-outline-success">商品分析</a>
                </div>
            </div>
        </div>
        
        <!-- 数据卡片 -->
        <div class="row g-4 mb-4">
            <div class="col-md-6 col-lg-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-success bg-opacity-10 p-3 rounded-circle me-3">
                                <i class="bi bi-people text-success fs-4"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 text-muted">农户总数</h6>
                                <h3 class="mb-0" th:text="${statistics.farmerCount}">0</h3>
                            </div>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 75%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 col-lg-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                                <i class="bi bi-box-seam text-primary fs-4"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 text-muted">商品总数</h6>
                                <h3 class="mb-0" th:text="${statistics.productCount}">0</h3>
                            </div>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: 65%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 col-lg-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-warning bg-opacity-10 p-3 rounded-circle me-3">
                                <i class="bi bi-person-badge text-warning fs-4"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 text-muted">职工总数</h6>
                                <h3 class="mb-0" th:text="${statistics.employeeCount}">0</h3>
                            </div>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: 45%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 col-lg-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-info bg-opacity-10 p-3 rounded-circle me-3">
                                <i class="bi bi-clipboard-check text-info fs-4"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 text-muted">待审核商品</h6>
                                <h3 class="mb-0" th:text="${statistics.pendingProductCount}">0</h3>
                            </div>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-info" role="progressbar" style="width: 30%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 图表区域 -->
        <div class="row g-4">
            <!-- 农户统计图表 -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">农户区域分布</h5>
                            <a th:href="@{/admin/statistics/farmers}" class="btn btn-sm btn-outline-success">
                                查看详情 <i class="bi bi-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="farmerChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- 商品统计图表 -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">商品类别分布</h5>
                            <a th:href="@{/admin/statistics/products}" class="btn btn-sm btn-outline-success">
                                查看详情 <i class="bi bi-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="productChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- 销量前5的商品 -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0">销量前5的商品</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>商品名称</th>
                                        <th>农户</th>
                                        <th>价格</th>
                                        <th>销量</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="product : ${statistics.topSellingProducts}">
                                        <td th:text="${product.name}">商品名称</td>
                                        <td th:text="${product.farmerName}">农户</td>
                                        <td th:text="${'￥' + product.price}">价格</td>
                                        <td th:text="${product.salesCount}">销量</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 农户增长趋势 -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0">农户增长趋势</h5>
                    </div>
                    <div class="card-body">
                        <div id="farmerTrendChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 图表初始化脚本 -->
        <script th:fragment="scripts" th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function() {
                // 获取统计数据
                const statistics = /*[[${statistics}]]*/ {};
                
                // 初始化农户区域分布图
                initFarmerChart(statistics.farmersByProvince || {});
                
                // 初始化商品类别分布图
                initProductChart(statistics.productsByCategory || {});
                
                // 初始化农户增长趋势图
                initFarmerTrendChart(statistics.farmersByMonth || {});
            });
            
            // 初始化农户区域分布图
            function initFarmerChart(data) {
                const chart = echarts.init(document.getElementById('farmerChart'));
                
                const provinces = Object.keys(data);
                const values = provinces.map(province => data[province]);
                
                const option = {
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c} ({d}%)'
                    },
                    legend: {
                        orient: 'vertical',
                        right: 10,
                        top: 'center',
                        data: provinces
                    },
                    color: ['#2ecc71', '#3498db', '#9b59b6', '#f1c40f', '#e67e22', '#95a5a6'],
                    series: [
                        {
                            name: '农户分布',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 10,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: false,
                                position: 'center'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: '16',
                                    fontWeight: 'bold'
                                }
                            },
                            labelLine: {
                                show: false
                            },
                            data: provinces.map((province, index) => {
                                return {
                                    value: values[index],
                                    name: province
                                };
                            })
                        }
                    ]
                };
                
                chart.setOption(option);
                
                window.addEventListener('resize', function() {
                    chart.resize();
                });
            }
            
            // 初始化商品类别分布图
            function initProductChart(data) {
                const chart = echarts.init(document.getElementById('productChart'));
                
                const categories = Object.keys(data);
                const values = categories.map(category => data[category]);
                
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            type: 'category',
                            data: categories,
                            axisTick: {
                                alignWithLabel: true
                            }
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value'
                        }
                    ],
                    series: [
                        {
                            name: '商品数量',
                            type: 'bar',
                            barWidth: '60%',
                            data: values,
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: '#83c44e' },
                                    { offset: 1, color: '#5cb85c' }
                                ])
                            }
                        }
                    ]
                };
                
                chart.setOption(option);
                
                window.addEventListener('resize', function() {
                    chart.resize();
                });
            }
            
            // 初始化农户增长趋势图
            function initFarmerTrendChart(data) {
                const chart = echarts.init(document.getElementById('farmerTrendChart'));
                
                const months = Object.keys(data).sort();
                const values = months.map(month => data[month]);
                
                const option = {
                    tooltip: {
                        trigger: 'axis'
                    },
                    xAxis: {
                        type: 'category',
                        data: months,
                        axisLabel: {
                            formatter: function(value) {
                                return value.split('-')[1] + '月';
                            }
                        }
                    },
                    yAxis: {
                        type: 'value'
                    },
                    series: [
                        {
                            data: values,
                            type: 'line',
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 8,
                            lineStyle: {
                                color: '#2ecc71',
                                width: 3
                            },
                            itemStyle: {
                                color: '#2ecc71'
                            },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(46, 204, 113, 0.3)' },
                                    { offset: 1, color: 'rgba(46, 204, 113, 0.1)' }
                                ])
                            }
                        }
                    ]
                };
                
                chart.setOption(option);
                
                window.addEventListener('resize', function() {
                    chart.resize();
                });
            }
        </script>
    </section>
</body>
</html> 