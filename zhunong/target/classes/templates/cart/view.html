<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layout/base :: layout(~{::title}, ~{::section})}">
<head>
    <meta charset="UTF-8">
    <title>购物车 - 暖心助农选品平台</title>
</head>
<body>
    <section>
        <!-- 成功/错误消息提示 -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span th:text="${successMessage}">操作成功</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span th:text="${errorMessage}">操作失败</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        
        <!-- 页面标题 -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
            <div>
                <h2 class="mb-1 d-flex align-items-center">
                    <i class="bi bi-cart3 me-2 text-primary"></i>我的购物车
                </h2>
                <p class="text-muted mb-0">查看和管理您的购物车商品</p>
            </div>
            <div class="mt-3 mt-md-0">
                <a th:href="@{/product/list}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left me-1"></i>继续选购
                </a>
            </div>
        </div>
        
        <div th:if="${#lists.isEmpty(cartItems)}" class="empty-state">
            <i class="bi bi-cart-x empty-state-icon"></i>
            <h5 class="empty-state-text">购物车空空如也</h5>
            <p class="empty-state-subtext">去选购一些优质农产品吧！</p>
            <div class="d-flex gap-2 justify-content-center">
                <a th:href="@{/product/list}" class="btn btn-primary">
                    <i class="bi bi-basket me-1"></i>去选购商品
                </a>
                <button class="btn btn-outline-success" onclick="createSampleOrder()">
                    <i class="bi bi-lightning me-1"></i>创建示例订单
                </button>
            </div>
        </div>
        
        <div th:if="${not #lists.isEmpty(cartItems)}" class="cart-container">
            <!-- 购物车列表 -->
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">购物车商品</h5>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearCart()">
                        <i class="bi bi-trash me-1"></i>清空购物车
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>商品信息</th>
                                    <th>单价</th>
                                    <th style="width: 150px;">数量</th>
                                    <th>小计</th>
                                    <th style="width: 80px;">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="item : ${cartItems}" th:data-product-id="${item.productId}">
                                    <td>
                                        <div class="d-flex">
                                            <img th:src="${item.productImage}" alt="商品图片" class="me-3 rounded" style="width: 80px; height: 80px; object-fit: cover;">
                                            <div>
                                                <a th:href="@{/product/detail/{id}(id=${item.productId})}" class="text-decoration-none">
                                                    <h6 class="mb-1" th:text="${item.productName}">商品名称</h6>
                                                </a>
                                                <div class="text-muted small d-flex align-items-center">
                                                    <i class="bi bi-person-circle me-1"></i>
                                                    <span th:text="${item.farmerName}">农户名称</span>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="fw-medium text-primary" th:text="'￥' + ${item.price}">单价</span>
                                    </td>
                                    <td>
                                        <div class="input-group input-group-sm quantity-control">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    th:onclick="|updateQuantity(${item.productId}, -1, this)|"
                                                    th:disabled="${item.quantity <= 1}">
                                                <i class="bi bi-dash"></i>
                                            </button>
                                            <input type="text" class="form-control text-center quantity-input" 
                                                   th:value="${item.quantity}" readonly>
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    th:onclick="|updateQuantity(${item.productId}, 1, this)|">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="fw-bold text-primary" th:text="'￥' + ${item.subtotal}">小计</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" th:onclick="|removeItem(${item.productId})|">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 结算区域 -->
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="address" class="form-label">收货地址</label>
                                <input type="text" class="form-control" id="address" required>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">联系电话</label>
                                <input type="tel" class="form-control" id="phone" required>
                            </div>
                            <div class="mb-3">
                                <label for="remark" class="form-label">备注</label>
                                <textarea class="form-control" id="remark" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">订单汇总</h5>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>商品总额：</span>
                                        <span class="fw-medium" th:text="'￥' + ${totalAmount}">￥0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>配送费：</span>
                                        <span class="fw-medium">￥0.00</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between mb-3">
                                        <span class="fw-bold">应付金额：</span>
                                        <span class="fw-bold text-danger fs-5" th:text="'￥' + ${totalAmount}">￥0.00</span>
                                    </div>
                                    <button class="btn btn-primary w-100" onclick="submitOrder()">
                                        <i class="bi bi-credit-card me-1"></i>提交订单
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- 支付确认模态框 -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认支付</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="bi bi-credit-card-2-front text-primary" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">订单支付</h5>
                        <p class="text-muted">请确认订单信息并完成支付</p>
                    </div>
                    
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span>订单编号：</span>
                                <span class="fw-medium" id="orderNoDisplay">--</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>支付金额：</span>
                                <span class="fw-bold text-danger" id="paymentAmountDisplay">￥0.00</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>账户余额：</span>
                                <span class="fw-medium" id="accountBalanceDisplay">￥0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-danger d-none" id="insufficientFundsAlert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        账户余额不足，请先充值
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmPaymentBtn" onclick="processPayment()">
                        <i class="bi bi-credit-card me-1"></i>确认支付
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script th:fragment="scripts">
        let paymentData = {};
        
        // 添加Toast提示函数
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'bg-success' : 
                       type === 'danger' ? 'bg-danger' : 
                       type === 'warning' ? 'bg-warning' : 'bg-info';
            
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center ${bgClass} text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="关闭"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            const toastElement = document.getElementById(toastId);
            if (typeof bootstrap !== 'undefined') {
                const toast = new bootstrap.Toast(toastElement, {
                    autohide: true,
                    delay: 3000
                });
                
                toast.show();
                
                // 自动删除toast元素
                toastElement.addEventListener('hidden.bs.toast', function() {
                    toastElement.remove();
                });
            } else {
                // 如果bootstrap未加载，使用简单的替代方案
                toastElement.style.display = 'block';
                setTimeout(() => {
                    toastElement.remove();
                }, 3000);
            }
        }
    
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '5';
            document.body.appendChild(container);
            return container;
        }
        
        // 更新商品数量
        function updateQuantity(productId, delta, button) {
            const row = button.closest('tr');
            const quantityInput = row.querySelector('.quantity-input');
            const currentQuantity = parseInt(quantityInput.value);
            const newQuantity = currentQuantity + delta;
            
            if (newQuantity < 1) return;
            
            // 显示加载状态
            button.disabled = true;
            
            // 显示处理中提示
            showToast('正在更新商品数量...', 'info');
            
            // 使用fetch API发送请求
            fetch(`/cart/update/${productId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `delta=${delta}`,
                credentials: 'same-origin'
            })
            .then(response => {
                if (response.ok) {
                    showToast('商品数量已更新', 'success');
                    // 延迟刷新页面，让用户看到成功消息
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    return response.text().then(text => {
                        throw new Error(text || '更新商品数量失败');
                    });
                }
            })
            .catch(error => {
                console.error('更新商品数量失败:', error);
                showToast('更新商品数量失败: ' + error.message, 'danger');
                button.disabled = false;
            });
        }
        
        // 从购物车移除商品
        function removeItem(productId) {
            if (confirm('确定要从购物车中移除此商品吗？')) {
                // 显示处理中提示
                showToast('正在移除商品...', 'info');
                
                // 使用fetch API发送请求
                fetch(`/cart/remove/${productId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (response.ok) {
                        showToast('商品已从购物车中移除', 'success');
                        // 延迟刷新页面，让用户看到成功消息
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        return response.text().then(text => {
                            throw new Error(text || '移除商品失败');
                        });
                    }
                })
                .catch(error => {
                    console.error('移除商品失败:', error);
                    showToast('移除商品失败: ' + error.message, 'danger');
                });
            }
        }
        
        // 清空购物车
        function clearCart() {
            if (confirm('确定要清空购物车吗？此操作不可恢复！')) {
                // 显示处理中提示
                showToast('正在清空购物车...', 'info');
                
                // 使用fetch API发送请求
                fetch('/cart/clear', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (response.ok) {
                        showToast('购物车已清空', 'success');
                        // 延迟刷新页面，让用户看到成功消息
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        return response.text().then(text => {
                            throw new Error(text || '清空购物车失败');
                        });
                    }
                })
                .catch(error => {
                    console.error('清空购物车失败:', error);
                    showToast('清空购物车失败: ' + error.message, 'danger');
                });
            }
        }
        
        // 提交订单
        function submitOrder() {
            const address = document.getElementById('address').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const remark = document.getElementById('remark').value.trim();
            
            if (!address) {
                showToast('请填写收货地址', 'warning');
                return;
            }
            
            if (!phone) {
                showToast('请填写联系电话', 'warning');
                return;
            }
            
            // 显示加载状态
            const submitBtn = document.querySelector('.btn-primary');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 处理中...';
            
            // 创建订单数据
            const orderData = {
                address: address,
                phone: phone,
                remark: remark
            };
            
            // 发送请求
            http.post('/order/create', orderData, {
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.data) {
                    if (typeof response.data === 'string' && response.data.includes('错误')) {
                        showToast(response.data, 'danger');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-credit-card me-1"></i>提交订单';
                    } else {
                        // 订单创建成功，显示支付模态框
                        paymentData = response.data;
                        
                        try {
                            // 更新模态框数据，确保所有需要的属性都存在
                            if (paymentData && paymentData.orderNo) {
                                const orderNoDisplay = document.getElementById('orderNoDisplay');
                                if (orderNoDisplay) orderNoDisplay.innerText = paymentData.orderNo;
                                
                                const paymentAmountDisplay = document.getElementById('paymentAmountDisplay');
                                if (paymentAmountDisplay) paymentAmountDisplay.innerText = `￥${paymentData.totalAmount || 0}`;
                                
                                const accountBalanceDisplay = document.getElementById('accountBalanceDisplay');
                                if (accountBalanceDisplay && paymentData.employeeBalance !== undefined) {
                                    accountBalanceDisplay.innerText = `￥${paymentData.employeeBalance || 0}`;
                                }
                                
                                // 检查余额是否充足
                                const insufficientFundsAlert = document.getElementById('insufficientFundsAlert');
                                const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
                                
                                if (insufficientFundsAlert && confirmPaymentBtn) {
                                    const totalAmount = paymentData.totalAmount || 0;
                                    const balance = paymentData.employeeBalance || 0;
                                    
                                    if (balance < totalAmount) {
                                        insufficientFundsAlert.classList.remove('d-none');
                                        confirmPaymentBtn.disabled = true;
                                    } else {
                                        insufficientFundsAlert.classList.add('d-none');
                                        confirmPaymentBtn.disabled = false;
                                    }
                                }
                                
                                // 显示模态框
                                const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
                                paymentModal.show();
                            } else {
                                throw new Error('订单数据不完整');
                            }
                        } catch (err) {
                            console.error('处理订单数据失败:', err);
                            showToast('订单创建成功，但无法显示支付界面', 'warning');
                            // 刷新页面
                            setTimeout(() => {
                                window.location.href = '/order/employee/list';
                            }, 2000);
                        }
                    }
                }
            })
            .catch(error => {
                console.error('提交订单失败:', error);
                showToast('提交订单失败，请稍后重试', 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-credit-card me-1"></i>提交订单';
            });
        }
        
        // 处理支付
        function processPayment() {
            if (!paymentData || !paymentData.orderNo) {
                showToast('订单数据异常，请重试', 'danger');
                return;
            }
            
            // 显示加载状态
            const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
            if (confirmPaymentBtn) {
                confirmPaymentBtn.disabled = true;
                confirmPaymentBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 处理中...';
            }
            
            // 发送请求
            http.post(`/order/pay/${paymentData.orderNo}`)
            .then(response => {
                // 隐藏模态框
                try {
                    const paymentModal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
                    if (paymentModal) paymentModal.hide();
                } catch (e) {
                    console.error('关闭模态框失败:', e);
                }
                
                if (response.data) {
                    if (response.data.success) {
                        showToast('支付成功', 'success');
                        setTimeout(() => {
                            window.location.href = `/order/employee/detail/no/${paymentData.orderNo}`;
                        }, 1500);
                    } else {
                        showToast(response.data.message || '支付失败，请稍后重试', 'danger');
                        if (confirmPaymentBtn) {
                            confirmPaymentBtn.disabled = false;
                            confirmPaymentBtn.innerHTML = '<i class="bi bi-credit-card me-1"></i>确认支付';
                        }
                    }
                } else {
                    showToast('支付结果未知，请查看订单状态', 'warning');
                    setTimeout(() => {
                        window.location.href = '/order/employee/list';
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('支付失败:', error);
                showToast('支付失败，请稍后重试', 'danger');
                if (confirmPaymentBtn) {
                    confirmPaymentBtn.disabled = false;
                    confirmPaymentBtn.innerHTML = '<i class="bi bi-credit-card me-1"></i>确认支付';
                }
            });
        }
        
        // 创建示例订单
        function createSampleOrder() {
            showToast('正在创建示例订单...', 'info');
            
            http.post('/cart/sample')
            .then(response => {
                if (response.data && typeof response.data === 'string') {
                    showToast(response.data, response.data.includes('成功') ? 'success' : 'danger');
                    if (response.data.includes('成功')) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                }
            })
            .catch(error => {
                console.error('创建示例订单失败:', error);
                showToast('创建示例订单失败，请稍后重试', 'danger');
            });
        }
        
        // 页面加载完成后
        document.addEventListener('DOMContentLoaded', function() {
            // 预填充用户信息
            const userPhone = document.getElementById('phone');
            const userAddress = document.getElementById('address');
            
            if (userPhone && userAddress) {
                http.get('/user/profile/info')
                .then(response => {
                    if (response.data) {
                        userPhone.value = response.data.phone || '';
                        userAddress.value = response.data.address || '';
                    }
                })
                .catch(error => {
                    console.error('获取用户信息失败:', error);
                });
            }
        });
    </script>
    
    <style th:fragment="styles">
        .empty-state {
            text-align: center;
            padding: 3rem 0;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .empty-state-text {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .empty-state-subtext {
            margin-bottom: 1.5rem;
        }
        
        .quantity-control {
            max-width: 120px;
        }
        
        .quantity-input {
            text-align: center;
            font-weight: 500;
        }
        
        @media (max-width: 767.98px) {
            .table th, .table td {
                padding: 0.75rem 0.5rem;
            }
        }
    </style>
</body>
</html>