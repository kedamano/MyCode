<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>注册 - 暖心助农选品平台</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container">
        <div class="row justify-content-center mt-5">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-center">注册</h3>
                    </div>
                    <div class="card-body">
                        <form id="registerForm">
                            <div class="mb-3">
                                <label for="username" class="form-label">用户名</label>
                                <input type="text" class="form-control" id="username" name="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">密码</label>
                                <input type="password" class="form-control" id="password" name="password" required>
                            </div>
                            <div class="mb-3">
                                <label for="realName" class="form-label">真实姓名</label>
                                <input type="text" class="form-control" id="realName" name="realName" required>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">手机号</label>
                                <input type="tel" class="form-control" id="phone" name="phone" required>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">邮箱</label>
                                <input type="email" class="form-control" id="email" name="email">
                            </div>
                            <div class="mb-3">
                                <label for="address" class="form-label">详细地址</label>
                                <input type="text" class="form-control" id="address" name="address" placeholder="省市区详细地址">
                            </div>
                            <div class="mb-3">
                                <label for="role" class="form-label">注册身份</label>
                                <select class="form-select" id="role" name="role" required>
                                    <option value="">请选择</option>
                                    <option value="FARMER">农户</option>
                                </select>
                                <div class="form-text text-info" id="roleHelp">
                                    <i class="bi bi-info-circle"></i>
                                    注册为农户后，需等待平台管理员审核通过才能登录使用
                                </div>
                            </div>
                            <div id="farmerFields" style="display: none;">
                                <div class="mb-3">
                                    <label for="farmName" class="form-label">农场/基地名称</label>
                                    <input type="text" class="form-control" id="farmName" name="farmName">
                                </div>
                                <div class="mb-3">
                                    <label for="farmingType" class="form-label">种植/养殖类型</label>
                                    <select class="form-select" id="farmingType" name="farmingType">
                                        <option value="">请选择</option>
                                        <option value="蔬菜">蔬菜</option>
                                        <option value="水果">水果</option>
                                        <option value="粮油">粮油</option>
                                        <option value="家禽">家禽</option>
                                        <option value="畜牧">畜牧</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">农户简介</label>
                                    <textarea class="form-control" id="description" name="description" rows="3" placeholder="简单介绍您的农场和产品特色"></textarea>
                                </div>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">注册</button>
                            </div>
                        </form>
                        <div class="text-center mt-3">
                            <a th:href="@{/user/login}" class="text-decoration-none">已有账号？点击登录</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.3.4/axios.min.js"></script>
    <script>
        // 创建一个基本的Toast通知函数
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'bg-success' : 
                          type === 'danger' ? 'bg-danger' : 
                          type === 'warning' ? 'bg-warning' : 'bg-info';
            
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center ${bgClass} text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="关闭"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 3000
            });
            
            toast.show();
            
            // 自动删除toast元素
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '5';
            document.body.appendChild(container);
            return container;
        }

        // 根据选择的角色显示/隐藏农户特定字段
        document.getElementById('role').addEventListener('change', function() {
            const farmerFields = document.getElementById('farmerFields');
            if (this.value === 'FARMER') {
                farmerFields.style.display = 'block';
            } else {
                farmerFields.style.display = 'none';
            }
        });

        // 注册表单处理
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                realName: document.getElementById('realName').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value,
                role: document.getElementById('role').value
            };
            
            // 如果是农户角色，添加农户特定字段
            if (formData.role === 'FARMER') {
                formData.farmName = document.getElementById('farmName').value;
                formData.farmingType = document.getElementById('farmingType').value;
                formData.description = document.getElementById('description').value;
            }

            // 显示加载中
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>处理中...';

            axios.post('/user/register', formData, {
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                showToast(response.data, 'success');
                
                if (response.data.includes('成功')) {
                    setTimeout(() => {
                        window.location.href = '/user/login';
                    }, 1500);
                } else {
                    // 恢复按钮状态
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const errorMessage = error.response?.data || '注册失败，请重试';
                showToast(errorMessage, 'danger');
                
                // 恢复按钮状态
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });
        });
    </script>
</body>
</html> 