<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(~{::title}, ~{::section})}">
<head>
    <meta charset="UTF-8">
    <title>订单详情 - 暖心助农选品平台</title>
</head>
<body>
    <section>
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
            <div>
                <h2 class="mb-1 d-flex align-items-center">
                    <i class="bi bi-receipt-cutoff me-2 text-primary"></i>订单详情
                </h2>
                <p class="text-muted mb-0">查看订单的详细信息</p>
            </div>
            <div class="d-flex gap-2">
                <!-- 待付款状态显示支付按钮 -->
                <button th:if="${order.status == '待付款'}" 
                        class="btn btn-success" 
                        onclick="showPaymentModal()">
                    <i class="bi bi-credit-card me-1"></i>立即支付
                </button>
                <a href="javascript:history.back()" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left me-2"></i>返回列表
                </a>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card mb-4 mb-lg-0">
                    <div class="card-header d-flex align-items-center">
                        <i class="bi bi-info-circle me-2"></i>
                        <span>基本信息</span>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-4 text-muted">订单编号</div>
                            <div class="col-8 fw-medium" th:text="${order.orderNo}"></div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-4 text-muted">买家姓名</div>
                            <div class="col-8" th:text="${order.employeeName}"></div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-4 text-muted">订单金额</div>
                            <div class="col-8 text-primary fw-bold" th:text="'￥' + ${order.totalAmount}"></div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-4 text-muted">订单状态</div>
                            <div class="col-8">
                                <span class="badge" 
                                      th:classappend="${order.status == '待付款' ? 'bg-warning' : (order.status == '已付款' ? 'bg-info' : (order.status == '已发货' ? 'bg-primary' : (order.status == '已收货' ? 'bg-success' : 'bg-secondary')))}"
                                      th:text="${order.status}">
                                    状态
                                </span>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-4 text-muted">下单时间</div>
                            <div class="col-8" th:text="${#temporals.format(order.createTime, 'yyyy-MM-dd HH:mm')}"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <i class="bi bi-geo-alt me-2"></i>
                        <span>收货信息</span>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-4 text-muted">收货人</div>
                            <div class="col-8" th:text="${order.employeeName}"></div>
                        </div>
                        <div class="row mb-3" th:if="${order.phone != null}">
                            <div class="col-4 text-muted">联系电话</div>
                            <div class="col-8" th:text="${order.phone}"></div>
                        </div>
                        <div class="row mb-3" th:if="${order.address != null}">
                            <div class="col-4 text-muted">收货地址</div>
                            <div class="col-8" th:text="${order.address}"></div>
                        </div>
                        <div class="row mb-3" th:if="${order.remark != null}">
                            <div class="col-4 text-muted">订单备注</div>
                            <div class="col-8" th:text="${order.remark}"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-box-seam me-2"></i>
                <span>订单商品</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>商品名称</th>
                                <th>单价</th>
                                <th>数量</th>
                                <th>小计</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="item : ${order.items}">
                                <td th:text="${item.productName}"></td>
                                <td th:text="'￥' + ${item.price}"></td>
                                <td th:text="${item.quantity}"></td>
                                <td class="text-primary fw-bold" th:text="'￥' + ${item.subtotal}"></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end fw-bold">总计：</td>
                                <td class="text-primary fw-bold" th:text="'￥' + ${order.totalAmount}"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 支付确认模态框 -->
        <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">确认支付</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-4">
                            <i class="bi bi-credit-card-2-front text-primary" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">订单支付</h5>
                            <p class="text-muted">请确认订单信息并完成支付</p>
                        </div>
                        
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>订单编号：</span>
                                    <span class="fw-medium" th:text="${order.orderNo}" id="orderNoDisplay"></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>支付金额：</span>
                                    <span class="fw-bold text-danger" th:text="'￥' + ${order.totalAmount}" id="paymentAmountDisplay"></span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>账户余额：</span>
                                    <span class="fw-medium" id="accountBalanceDisplay">￥0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-danger d-none" id="insufficientFundsAlert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            账户余额不足，请先充值
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="confirmPaymentBtn" onclick="processPayment()">
                            <i class="bi bi-credit-card me-1"></i>确认支付
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <script th:fragment="scripts">
        // 显示支付模态框
        function showPaymentModal() {
            // 获取账户余额
            axios.get('/account/balance/check')
                .then(response => {
                    const accountData = response.data;
                    if (accountData && accountData.balance !== undefined) {
                        document.getElementById('accountBalanceDisplay').textContent = '￥' + accountData.balance;
                        
                        // 获取订单金额
                        const orderAmountText = document.getElementById('paymentAmountDisplay').textContent;
                        const orderAmount = parseFloat(orderAmountText.replace('￥', ''));
                        
                        // 检查余额是否足够
                        const insufficientFundsAlert = document.getElementById('insufficientFundsAlert');
                        const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
                        
                        if (accountData.balance < orderAmount) {
                            insufficientFundsAlert.classList.remove('d-none');
                            confirmPaymentBtn.disabled = true;
                        } else {
                            insufficientFundsAlert.classList.add('d-none');
                            confirmPaymentBtn.disabled = false;
                        }
                        
                        // 显示模态框
                        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
                        paymentModal.show();
                    } else {
                        showToast('无法获取账户余额信息', 'warning');
                    }
                })
                .catch(error => {
                    console.error('Error fetching balance:', error);
                    showToast('获取账户余额失败，请重试', 'danger');
                });
        }
        
        // 处理支付
        function processPayment() {
            const orderNo = document.getElementById('orderNoDisplay').textContent;
            if (!orderNo) {
                showToast('订单号不能为空', 'danger');
                return;
            }
            
            // 显示加载状态
            showToast('正在处理支付...', 'info');
            
            axios.post('/order/pay/' + orderNo)
                .then(response => {
                    const result = response.data;
                    if (result && result.success) {
                        // 关闭支付模态框
                        const paymentModal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
                        if (paymentModal) {
                            paymentModal.hide();
                        }
                        
                        showToast('支付成功！', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        showToast(result && result.message ? result.message : '支付失败', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('支付处理失败，请重试', 'danger');
                });
        }
        
        // 显示提示消息
        function showToast(message, type = 'success') {
            // 创建或获取toast容器
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
                toastContainer.style.zIndex = '1050';
                document.body.appendChild(toastContainer);
            }
            
            // 创建toast元素
            const toastId = 'toast-' + Date.now();
            const toastEl = document.createElement('div');
            toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
            toastEl.id = toastId;
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            
            // 设置toast内容
            let icon = 'check-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            else if (type === 'danger') icon = 'exclamation-circle';
            else if (type === 'info') icon = 'info-circle';
            
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-${icon} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            // 添加到容器
            toastContainer.appendChild(toastEl);
            
            // 初始化并显示toast
            try {
                const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                toast.show();
                
                // 移除监听器
                toastEl.addEventListener('hidden.bs.toast', () => {
                    if (toastContainer.contains(toastEl)) {
                        toastContainer.removeChild(toastEl);
                    }
                });
            } catch (error) {
                console.error('Error showing toast:', error);
                // 备用方案：如果bootstrap不可用，使用setTimeout移除
                setTimeout(() => {
                    if (toastContainer.contains(toastEl)) {
                        toastContainer.removeChild(toastEl);
                    }
                }, 3000);
            }
        }
    </script>
</body>
</html> 