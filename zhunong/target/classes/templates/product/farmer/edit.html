<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(~{::title}, ~{::section})}">
<head>
    <meta charset="UTF-8">
    <title th:text="${product.id == null ? '添加商品' : '编辑商品'} + ' - 暖心助农选品平台'">添加/编辑商品</title>
</head>
<body>
    <section>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1 d-flex align-items-center">
                    <i class="bi bi-pencil-square me-2 text-primary"></i>
                    <span th:text="${product.id == null ? '添加商品' : '编辑商品'}">编辑商品</span>
                </h2>
                <p class="text-muted mb-0">修改商品信息，确保信息准确有吸引力</p>
            </div>
            <a th:href="@{/product/farmer/list}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left me-2"></i>返回商品列表
            </a>
        </div>
        
        <div class="card">
            <div class="card-body">
                <form id="farmerProductForm" th:action="@{/product/farmer/save}" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                    <input type="hidden" name="id" th:value="${product.id}">
                    
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">商品名称</label>
                                <input type="text" class="form-control" id="name" name="name" th:value="${product.name}" required>
                                <div class="invalid-feedback">请输入商品名称</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="price" class="form-label">价格 (元)</label>
                                <div class="input-group">
                                    <span class="input-group-text">￥</span>
                                    <input type="number" class="form-control" id="price" name="price" th:value="${product.price}" 
                                           step="0.01" min="0.01" required>
                                    <div class="invalid-feedback">请输入有效价格</div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="stock" class="form-label">库存数量</label>
                                <input type="number" class="form-control" id="stock" name="stock" th:value="${product.stock}" 
                                       min="1" required>
                                <div class="invalid-feedback">请输入库存数量</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="category" class="form-label">商品分类</label>
                                <select class="form-select" id="category" name="category" required>
                                    <option value="">请选择分类</option>
                                    <option value="水果" th:selected="${product.category == '水果'}">水果</option>
                                    <option value="蔬菜" th:selected="${product.category == '蔬菜'}">蔬菜</option>
                                    <option value="粮油" th:selected="${product.category == '粮油'}">粮油</option>
                                    <option value="其他" th:selected="${product.category == '其他'}">其他</option>
                                </select>
                                <div class="invalid-feedback">请选择商品分类</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="description" class="form-label">商品描述</label>
                                <textarea class="form-control" id="description" name="description" rows="4" 
                                          th:text="${product.description}" required></textarea>
                                <div class="invalid-feedback">请输入商品描述</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="imageFile" class="form-label">商品图片</label>
                                <input type="file" class="form-control" id="imageFile" name="imageFile" accept="image/*">
                                <div class="form-text" th:if="${product.id != null}">如果不上传新图片，将保留原图片</div>
                            </div>
                            
                            <div class="mb-3" th:if="${product.image != null}">
                                <label class="form-label">当前图片</label>
                                <div class="text-center p-3 border rounded bg-light">
                                    <img th:src="@{${product.image}}" alt="商品图片" class="img-fluid" style="max-height: 200px;">
                                    <input type="hidden" name="image" th:value="${product.image}">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end mt-4">
                        <a th:href="@{/product/farmer/list}" class="btn btn-outline-secondary me-2">
                            <i class="bi bi-x-circle me-1"></i>取消
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>保存修改
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>
    
    <script th:fragment="scripts">
        // 表单验证和提交
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('farmerProductForm');
            
            if (form) {
                form.addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    if (!this.checkValidity()) {
                        event.stopPropagation();
                        this.classList.add('was-validated');
                        return;
                    }
                    
                    this.classList.add('was-validated');
                    
                    // 创建FormData对象
                    const formData = new FormData(this);
                    
                    // 发送请求
                    http.post('/product/farmer/save', formData, {
                        headers: {
                            'Content-Type': 'multipart/form-data'
                        }
                    })
                    .then(response => {
                        showToast('商品信息保存成功', 'success');
                        
                        // 跳转到商品列表页
                        setTimeout(() => {
                            window.location.href = '/product/farmer/list';
                        }, 1000);
                    })
                    .catch(error => {
                        const errorMessage = error.response?.data || '保存失败，请检查表单并重试';
                        showToast(errorMessage, 'danger');
                    });
                });
            }
        });
    </script>
</body>
</html>